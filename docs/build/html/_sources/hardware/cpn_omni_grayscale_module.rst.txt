.. note::

    こんにちは、SunFounderのRaspberry Pi & Arduino & ESP32愛好家コミュニティへようこそ！Facebook上でRaspberry Pi、Arduino、ESP32についてもっと深く掘り下げ、他の愛好家と交流しましょう。

    **参加する理由は？**

    - **エキスパートサポート**：コミュニティやチームの助けを借りて、販売後の問題や技術的な課題を解決します。
    - **学び＆共有**：ヒントやチュートリアルを交換してスキルを向上させましょう。
    - **独占的なプレビュー**：新製品の発表や先行プレビューに早期アクセスしましょう。
    - **特別割引**：最新製品の独占割引をお楽しみください。
    - **祭りのプロモーションとギフト**：ギフトや祝日のプロモーションに参加しましょう。

    👉 私たちと一緒に探索し、創造する準備はできていますか？[|link_sf_facebook|]をクリックして今すぐ参加しましょう！

Omni Grayscaleモジュール
============================

.. image:: img/omni_grayscale_front.png
    :width: 300

.. image:: img/omni_grayscale_back.png
    :width: 300

* **VREF**: 参照電圧入力ピン。各センサーの値がこの参照電圧と比較され、出力が高いか低いかを決定します。
* **Q7**: 最終段からのシリアル出力
* **PL**: 非同期並列ロード入力（アクティブLOW）
* **CP**: クロック入力（LOWからHIGHへのエッジトリガー）
* **5V**: 3.3〜5V DC供給入力
* **GND**: グラウンド入力

このOmni Grayscaleモジュールは、ラインフォローとエッジ検出用です。Omniは全方向性を意味し、モジュールには、任意の方向の黒い線を検出するために、円に分布した8つのTCRT5000送信センサーがあります。

これにより、Mecanumホイールを持つZeus Carのようなロボットカーは、車の頭部が前方を向いていなくても、さまざまな角度でラインを追跡できます。

モジュールの現在の環境での感度は、VREF値を変更することで調整できます。Zeus Car Shiledでは、青いポテンショメーターがVREFピンの値を調整するために使用されます。

**動作原理**

* |link_tcrt5000_datasheet|

モジュール内には、8つのTCRT5000送信センサーが統合されており、これらは赤外光反射に基づいており、可視光を遮断する鉛材で覆われた赤外発光ダイオードとフォトトランジスタを含んでいます。

.. image:: img/tcrt5000_pin.jpg
    :width: 400
    :align: center

動作中、TCRT5000の赤外発光ダイオードは、950nmの波長で赤外光（目に見えない光）を連続して放射します。障害物によって放射された赤外光が反射されないか、反射強度が不足していると、フォトトランジスタは動作しません。赤外光が十分な強度で反射され、同時にフォトトランジスタに受信されると、フォトトランジスタは動作状態となり、出力を提供します。

* |link_lm339_datasheet|

このOmni Grayscaleモジュールには、合計8つの差動コンパレーターを含む2つのLM339チップがあります。これらの差動コンパレータは、現在のセンサー値と基準値を比較して、高いか低いかを判断するために使用されます。このようにして、黒い線が検出されたかどうかが分かります。

.. image:: img/lm339_chip.png

以下は、チャンネルの一部の回路図です。

.. image:: img/tcrt_lm339.png

* VREFピンで基準電圧を設定し（この基準電圧はZeus Car Shield上のポテンショメーターで設定します）、この基準電圧をコンパレータの反転入力（-）に追加します。
* TCRT5000センサーのフォトトランジスタのコレクターをコンパレータの同相入力（+）に追加します。
* TCRT5000センサーが放射した赤外線が反射されず、または反射強度が不足している場合、感光トランジスタは動作せず、この時、コレクターはプルアップ抵抗に5Vに接続されるので、コンパレータの同相入力（+）が反転入力（-）より大きくなります。
* コンパレータの出力は高く、インジケータは点灯しません。逆も同様です。
* 黒い表面は光を吸収するため、赤外光を反射するのが少なく、黒い表面上では、コンパレータが高出力でインジケータが点灯せず、白い表面は赤外線を反射して、感光トランジスタが動作し、同相入力の値が反転入力より小さいため、コンパレータは低出力でインジケータが点灯します。

この8つのセンサーデータは、74HC165（8ビット並列入力シリアル出力シフトレジスタ）を介してArduinoボードに転送されます。

* |link_74hc165_datasheet|

74HC165は8ビット並列入力シリアル出力シフトレジスタで、最終段でQ0とQ7の相互排他的なシリアル出力を取得できます。並列読取り(PL)入力が低い場合、D0からD7ポートからの並列データ入力が非同期でレジスタに読み込まれます。PLが高い場合、データはDS入力からシリアルでレジスタに入力され、各クロックパルスの立ち上がりエッジで1ビット右に移動します（Q0 → Q1 → Q2、など）。この機能を使用すると、Q7出力を次のレベルのDS入力にバインドするだけで、並列からシリアルへの展開が簡単に実現できます。

74HC165のクロック入力は「ゲーテッドオア」構造で、一つの入力を低アクティブクロック有効（CE）入力として使用できます。CPとCEのピン割り当ては独立しており、必要に応じて配線の便宜のために交換することができます。CPが高い状態の時にのみ、CEは低から高へと上がることが許可されます。PLのアクティブ状態でデータの変位を防ぐため、PLの立ち上がりエッジの前にCPまたはCEを高く設定する必要があります。

.. image:: img/74hc165_con.png

**特長**

* 動作電圧: 3.3 ~ 5V
* 出力: デジタル（オン/オフ）
* 非同期8ビット並列ロード
* 同期式シリアル入力
* 検出閾値: VREFピンで調整可能
* センサタイプ：TCRT5000
* コネクタモデル：ZH1.5-6P
* 動作温度範囲: -10℃ 〜 +50℃
* 外寸: 80mm x 80mm

**モジュールのキャリブレーション**

    各フロアは異なるグレースケール値を持っているため、工場設定のグレースケール閾値が現在の環境に適していない可能性があります。そのため、使用前にこのモジュールをキャリブレートする必要があります。床の色が大きく変わった時にはキャリブレーションを行うことをおすすめします。

    * Zeus Carを白い面に置き、灰色のセンサライトが点灯するまでポテンショメータを回します。

        .. image:: img/zeus_line_calibration.jpg

    * 両側のグレースケールセンサを黒いラインと白い面のちょうど間に位置させ、信号インジケータが消灯するまでゆっくりとポテンショメータを回します。

        .. image:: img/zeus_line_calibration1.jpg

    * 黒いラインと白い面を繰り返し移動させ、グレースケールセンサのライトが黒いラインと白い面の間にある時にはオフ、白い面にある時にはオンになっていることを確認します。これはモジュールが正常にキャリブレートされていることを示しています。





